<!-- Compact eSIM comparison card with CTAs and UTM tracking -->
<section class="esim-card" aria-labelledby="esim-card-title">
  <h2 id="esim-card-title">Best eSIMs for China — Quick Comparison</h2>

  <div class="esim-list">
    <article class="esim-item" data-provider="Airalo">
      <header>
        <h3 class="provider">Airalo</h3>
        <p class="tag">Recommended</p>
      </header>
      <ul class="meta">
        <li><strong>Speed:</strong> 4G/5G (carrier dependent)</li>
        <li><strong>Price:</strong> From $4</li>
        <li><strong>Ease:</strong> <span class="ease" aria-hidden="true">★★★★★</span><span class="sr">5/5 ease of setup</span></li>
      </ul>
      <p class="notes">Large catalog, instant in-app installs. Good for short trips.</p>
      <div class="actions">
        <a class="btn primary goto-affiliate" role="button" href="#" data-base-url="https://airalo.pxf.io/nXq9WX" data-provider="Airalo">Buy eSIM — Airalo</a>
      </div>
    </article>

    <article class="esim-item" data-provider="Holafly">
      <header>
        <h3 class="provider">Holafly</h3>
      </header>
      <ul class="meta">
        <li><strong>Speed:</strong> 4G/5G (carrier dependent)</li>
        <li><strong>Price:</strong> From $8 (unlimited plans available)</li>
        <li><strong>Ease:</strong> <span class="ease" aria-hidden="true">★★★★☆</span><span class="sr">4/5 ease of setup</span></li>
      </ul>
      <p class="notes">Unlimited plans and simple QR installs; slightly higher price.</p>
      <div class="actions">
        <a class="btn primary goto-affiliate" role="button" href="#" data-base-url="https://affiliate.example.com/holafly" data-provider="Holafly">Buy eSIM — Holafly</a>
      </div>
    </article>

    <article class="esim-item" data-provider="Nomad">
      <header>
        <h3 class="provider">Nomad</h3>
      </header>
      <ul class="meta">
        <li><strong>Speed:</strong> 4G/5G (carrier dependent)</li>
        <li><strong>Price:</strong> From $5</li>
        <li><strong>Ease:</strong> <span class="ease" aria-hidden="true">★★★★★</span><span class="sr">5/5 ease of setup</span></li>
      </ul>
      <p class="notes">Competitive pricing and flexible validity windows.</p>
      <div class="actions">
        <a class="btn primary goto-affiliate" role="button" href="#" data-base-url="https://affiliate.example.com/nomad" data-provider="Nomad">Buy eSIM — Nomad</a>
      </div>
    </article>
  </div>

  <div class="footer-cta">
    <p class="disclosure">We may earn a commission if you purchase through links on this page.</p>
    <a class="btn secondary goto-vpn" href="#" data-base-url="https://affiliate.example.com/expressvpn" data-provider="ExpressVPN">Get a VPN for China</a>
  </div>

  <style>
    /* Compact card styles */
    .esim-card{max-width:820px;margin:0 auto;padding:1rem;border:1px solid #e6e6e6;border-radius:10px;background:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    .esim-card h2{font-size:1.125rem;margin:0 0 .75rem}
    .esim-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.75rem}
    .esim-item{padding:.75rem;border-radius:8px;border:1px solid #f0f0f0;background:linear-gradient(180deg,#fff,#fbfbfb)}
    .esim-item header{display:flex;align-items:center;justify-content:space-between}
    .provider{margin:0;font-size:1rem}
    .tag{background:#ffefc7;color:#6a4b00;padding:.15rem .5rem;border-radius:999px;font-size:.75rem}
    .meta{list-style:none;padding:0;margin:.5rem 0;font-size:.875rem;color:#333}
    .meta li{margin:.25rem 0}
    .notes{margin:.5rem 0;font-size:.875rem;color:#555}
    .actions{display:flex;gap:.5rem}
    .btn{display:inline-block;padding:.5rem .7rem;border-radius:6px;text-decoration:none;font-weight:600;font-size:.9rem}
    .btn.primary{background:#0070f3;color:#fff;border:1px solid rgba(0,112,243,.15)}
    .btn.secondary{background:#fff;color:#0070f3;border:1px solid #dbeafe}
    .footer-cta{display:flex;align-items:center;justify-content:space-between;margin-top:1rem;gap:1rem}
    .disclosure{margin:0;font-size:.8rem;color:#666}
    .ease{color:#f5a623}
    .sr{position:absolute;left:-10000px;width:1px;height:1px;overflow:hidden}
    @media (max-width:520px){.footer-cta{flex-direction:column;align-items:flex-start}}
  </style>

  <script>
    (function(){
      // Simple UTM appender + click tracking
      var utm = {
        utm_source: 'site',
        utm_medium: 'affiliate',
        utm_campaign: 'china_esim_vpn'
      };

      function buildUrl(base, provider){
        var url = new URL(base);
        // append utm params if not already present
        Object.keys(utm).forEach(function(k){ if(!url.searchParams.has(k)) url.searchParams.set(k, utm[k]); });
        // add provider tag for better tracking
        if(!url.searchParams.has('utm_term')) url.searchParams.set('utm_term', provider);
        return url.toString();
      }

      function trackClick(provider, finalUrl){
        try{
          // Best-effort tracking: sendBeacon to analytics endpoint if available
          var payload = JSON.stringify({event:'affiliate_click',provider:provider,page:location.pathname,timestamp:Date.now(),url:finalUrl});
          if(navigator.sendBeacon){
            navigator.sendBeacon('/_collect_affiliate',payload);
          } else {
            // fallback to fetch (don't await)
            fetch('/_collect_affiliate',{method:'POST',headers:{'Content-Type':'application/json'},body:payload,keepalive:true}).catch(function(){/*ignore*/});
          }
        }catch(e){/*ignore tracking errors*/}
        // also log to console for debugging
        if(window.console && console.log){console.log('Affiliate click',provider,finalUrl)}
      }

      function onAffiliateClick(e){
        e.preventDefault();
        var el = e.currentTarget;
        var base = el.getAttribute('data-base-url') || el.href;
        var provider = el.getAttribute('data-provider') || 'unknown';
        var final = buildUrl(base,provider);
        trackClick(provider, final);
        // open in a new tab (use noopener for security)
        window.open(final, '_blank', 'noopener');
      }

      // wire up buttons
      var els = document.querySelectorAll('.goto-affiliate, .goto-vpn');
      els.forEach(function(a){ a.addEventListener('click', onAffiliateClick); });

      // graceful fallback: replace hrefs with built URL on load so right-click works
      document.addEventListener('DOMContentLoaded', function(){
        els.forEach(function(a){
          var base = a.getAttribute('data-base-url') || a.href;
          var provider = a.getAttribute('data-provider') || 'unknown';
          try{ a.href = buildUrl(base, provider); }catch(e){}
        });
      });
    })();
  </script>
</section>
